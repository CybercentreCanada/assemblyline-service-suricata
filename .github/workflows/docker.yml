name: Docker Image CI

on:
  push:
    tags:
        - test-*
jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag my-image-name:test
    - name: Change the permission to the volume
      run: sudo chmod -R 777 ${{ github.workspace }}
    - name: Run additional command
      run: |
        docker run --rm -v ${{ github.workspace }}:/tmp/repo my-image-name:test sh -c '/usr/local/bin/suricata -vvvv -c /usr/local/etc/suricata/suricata.yaml --unix-socket=/usr/local/var/run/suricata/suricata.socket --pidfile /usr/local/var/run/suricata/suricata.pid --set logging.outputs.1.file.filename=/usr/local/var/log/suricata/suricata.log -D; python -d -m assemblyline_v4_service.dev.run_service_once suricata_.suricata_.Suricata /tmp/repo/test/files/smb2_putty_xfer.pcap;'
      continue-on-error: true
    - name: Build results tar.gz
      run: |
        tar cvzf results.tar.gz ${{ github.workspace }}/test/files/smb2_putty_xfer.pcap_suricata/working_directory
      continue-on-error: true
    - name: Generate artifact
      uses: actions/upload-artifact@v2
      with:
        name: suricata-output
        path: ${{ github.workspace }}/test/files/smb2_putty_xfer.pcap_suricata/working_directory/*/*
    - name: Generate artifact 2
      uses: actions/upload-artifact@v2
      with:
        name: suricata-output
        path: results.tar.gz 